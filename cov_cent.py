import numpy as np


class Covariance(object):
    '''
    Define different Kalman Filter covariance matrix
    Kalman Filter states:
    [x, y, z, rot_y, l, w, h, x_dot, y_dot, z_dot]
    '''

    def __init__(self):
        self.num_states = 11
        self.num_observations = 7

        self.P = {}
        self.Q = {}
        self.R = {}

        NUSCENES_TRACKING_NAMES = [
            'bicycle',
            'bus',
            'car',
            'motorcycle',
            'pedestrian',
            'trailer',
            'truck'
        ]

        # Kalman Filter state: [x, y, z, rot_z, l, w, h, x_dot, y_dot, z_dot, rot_z_dot]

        P = {
            'bicycle': [0.04389963, 0.03891063, 0.04684107, 1.14530386, 0.03344048, 0.01459256, 0.0179011,
                        0.04024432, 0.03308606, 0.01506674, 0.96405419],
            'bus': [0.07441684, 0.06287754, 0.07717645, 0.15515833, 0.44215762, 0.0511534, 0.08510874,
                    0.07132446, 0.06317605, 0.04056452, 0.14242982],
            'car': [0.05076521, 0.05217449, 0.02870418,  0.62675554, 0.10512433, 0.02298498, 0.02266131,
                    0.03301909, 0.0325577, 0.01168534, 0.52676054],
            'motorcycle': [0.04282156, 0.04551483, 0.02464308, 0.85868852, 0.05109268, 0.0145726, 0.01619681,
                           0.0379135 , 0.03833368, 0.01196864, 0.77888364],
            'pedestrian': [0.04515334, 0.04249591, 0.02385418, 0.57556734,  0.02502636, 0.01470147, 0.02032242,
                          4.98518293e-02, 4.68486146e-02, 1.06178839e-02, 0.39072747],
            'trailer': [0.085356  , 0.08847322, 0.1784289 , 1.04661782, 0.98885655, 0.06104183, 0.09248428,
                        0.08043277, 0.07315326, 0.03804438, 0.61348677],
            'truck': [0.06961548, 0.06621301, 0.19690991, 0.41230103, 0.5043927, 0.05697113, 0.07384724,
                      0.05448486, 0.05018495, 0.02443776, 0.34236602]
        }

        Q = {
            'bicycle': [1.98881347e-02, 1.36552276e-02, 5.10175742e-03, 1.33430252e-01, 0, 0, 0, 1.98881347e-02,
                        1.36552276e-02, 5.10175742e-03, 1.33430252e-01],
            'bus': [1.17729925e-01, 8.84659079e-02, 1.17616440e-02, 2.09050032e-01, 0, 0, 0, 1.17729925e-01,
                    8.84659079e-02, 1.17616440e-02, 2.09050032e-01],
            'car': [1.58918523e-01, 1.24935318e-01, 5.35573165e-03, 9.22800791e-02, 0, 0, 0, 1.58918523e-01,
                    1.24935318e-01, 5.35573165e-03, 9.22800791e-02],
            'motorcycle': [3.23647590e-02, 3.86650974e-02, 5.47421635e-03, 2.34967407e-01, 0, 0, 0, 3.23647590e-02,
                           3.86650974e-02, 5.47421635e-03, 2.34967407e-01],
            'pedestrian': [3.34814566e-02, 2.47354921e-02, 5.94592529e-03, 4.24962535e-01, 0, 0, 0, 3.34814566e-02,
                           2.47354921e-02, 5.94592529e-03, 4.24962535e-01],
            'trailer': [4.19985099e-02, 3.68661552e-02, 1.19415050e-02, 5.63166240e-02, 0, 0, 0, 4.19985099e-02,
                        3.68661552e-02, 1.19415050e-02, 5.63166240e-02],
            'truck': [9.45275998e-02, 9.45620374e-02, 8.38061721e-03, 1.41680460e-01, 0, 0, 0, 9.45275998e-02,
                      9.45620374e-02, 8.38061721e-03, 1.41680460e-01]
        }

        R = {
            'bicycle': [0.04389963, 0.03891063, 0.04684107, 1.14530386, 0.03344048, 0.01459256, 0.0179011],
            'bus': [0.07441684, 0.06287754, 0.07717645, 0.15515833, 0.44215762, 0.0511534, 0.08510874],
            'car': [0.05076521, 0.05217449, 0.02870418,  0.62675554, 0.10512433, 0.02298498, 0.02266131],
            'motorcycle': [0.04282156, 0.04551483, 0.02464308, 0.85868852, 0.05109268, 0.0145726, 0.01619681],
            'pedestrian': [0.04515334, 0.04249591, 0.02385418, 0.57556734,  0.02502636, 0.01470147, 0.02032242],
            'trailer': [0.085356  , 0.08847322, 0.1784289 , 1.04661782, 0.98885655, 0.06104183, 0.09248428],
            'truck': [0.06961548, 0.06621301, 0.19690991, 0.41230103, 0.5043927, 0.05697113, 0.07384724]
        }

        for tracking_name in NUSCENES_TRACKING_NAMES:
            self.P[tracking_name] = np.diag(P[tracking_name])
            self.Q[tracking_name] = np.diag(Q[tracking_name])
            self.R[tracking_name] = np.diag(R[tracking_name])

    def get_S(self, tracking_name):
        """
        Retrieve P and Q elements corresponding to [x, y, l, w, vel_x, vel_y].
        """
        pos_vel = [0, 1, 7, 8]  # Indices for x, y, vel_x, vel_y
        geom = [4, 5]  # Indices for l, w

        P_tracking = self.P[tracking_name]
        Q_tracking = self.Q[tracking_name]
        R_tracking = self.R[tracking_name]

        P_subset = P_tracking[np.ix_(pos_vel, pos_vel)]
        Q_subset = Q_tracking[np.ix_(pos_vel, pos_vel)] 
        geom_cov = R_tracking[np.ix_(geom, geom)]

        return P_subset, Q_subset, geom_cov